<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2024a"><title>OptFill</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 15px 10px 0; display: inline-block }
.S1 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 1px solid rgb(217, 217, 217); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S2 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S3 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>OptFill</span></h1><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span style="color: #0e00ff;">function </span><span >[TICs,Direction] = OptFillTFP(model,database,mTFP)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% Enumerates all the Thermodynamically infeasible cycles in a given model</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% using OptFill's algorithm. This code is adapted based on codes written in </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% GAMS and python in the paper "OptFill: A Tool for Infeasible Cycle-Free </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% Gapfilling of Stoichiometric Metabolic Models"</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% USAGE: </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%   [TICs,Direction] = OptFillTFP(model,database,mTFP)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% INPUTS:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%     model:     COBRA model structure defining the actual model</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%     database:  COBRA model structure defining the database</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%     mTFP:      boolean value indicating whether to work on modified-TIC</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                finding problem (1) or TIC finding problem (0). In TIC</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                finding problem, atleast one reaction in a TIC will be</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                from the database.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% OUTPUTS:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%     TICs:       List of all the Thermodynamically infeasible cycles in</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                 the given input model-database pair</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%     Direction:  Relative flux coefficients for reactions </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                 in the corresponding TICs</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% .. Author:</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%       - Pavan Kumar S, BioSystems Engineering and control (BiSECt) lab, IIT Madras</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%       - Based on: Schroeder, W. L., &amp; Saha, R. (2020). OptFill: a tool </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                   for infeasible cycle-free gapfilling of stoichiometric </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">%                   metabolic models. IScience, 23(1).</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db = mergeTwoModels(model,database); </span><span style="color: #008013;">% the combined model</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.origin = ismember(m_Db.rxns,model.rxns); </span><span style="color: #008013;">% boolean vector indicating if a reaction is from model (1) or the database (0)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% parameters used were taken from the OptFill paper</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >epsilon=0.001;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >M=1000;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >tolerance=1e-6; </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >changeCobraSolverParams(</span><span style="color: #a709f5;">'LP'</span><span >, </span><span style="color: #a709f5;">'feasTol'</span><span >, tolerance);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >[~,max_phi] = size(m_Db.S); </span><span style="color: #008013;">% number of reactions in the model-database pair</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >IrR = m_Db.ub&lt;=0; </span><span style="color: #008013;">% reactions irreversible in reverse direction</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >temp = m_Db.ub(IrR);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.S(:,IrR) = -m_Db.S(:,IrR);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.ub(IrR) = -1*m_Db.lb(IrR);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.lb(IrR) = -1*temp;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >rev = ones(n,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >rev(m_Db.lb&gt;=0) = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.rev=rev;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% converting all the positive lower bounds to zero lower bounds</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.lb(m_Db.lb&gt;0)=0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% normalising the bounds to max of M</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >temp1 = max(abs(m_Db.lb));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >temp2 = max(abs(m_Db.ub));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.lb(abs(m_Db.lb)==temp1) = sign(m_Db.lb(abs(m_Db.lb)==temp1))*M;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.ub(abs(m_Db.ub)==temp2) = sign(m_Db.ub(abs(m_Db.ub)==temp2))*M;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >ind = findExcRxns(m_Db); </span><span style="color: #008013;">% indices of the exchange reactions</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #008013;">% blocking all the exchange reactions</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.lb(ind) = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >m_Db.ub(ind) = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >TICs={}; Direction = {}; </span><span style="color: #008013;">% empty cell to store the TICs and their respective direction</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >phi = 2:max_phi </span><span style="color: #008013;">% minimum size of a TIC has to be two</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    found_all = false;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">while </span><span >~found_all</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        [flux,stat] = findTIC(m_Db,phi,mTFP);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'>&nbsp;</div></div></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span style="color: #0e00ff;">function </span><span >[flux,stat] = findTIC(model,phi,mTFP)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S3'>&nbsp;</div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
function [TICs,Direction] = OptFillTFP(model,database,mTFP)
%% OPTFILLTFP OptFill
% Enumerates all the Thermodynamically infeasible cycles in a given model
% using OptFill's algorithm. This code is adapted based on codes written in 
% GAMS and python in the paper "OptFill: A Tool for Infeasible Cycle-Free 
% Gapfilling of Stoichiometric Metabolic Models"
% USAGE: 
%   [TICs,Direction] = OptFillTFP(model,database,mTFP)
%
% INPUTS:
%     model:     COBRA model structure defining the actual model
%     database:  COBRA model structure defining the database
%     mTFP:      boolean value indicating whether to work on modified-TIC
%                finding problem (1) or TIC finding problem (0). In TIC
%                finding problem, atleast one reaction in a TIC will be
%                from the database.
%
% OUTPUTS:
%     TICs:       List of all the Thermodynamically infeasible cycles in
%                 the given input model-database pair
%     Direction:  Relative flux coefficients for reactions 
%                 in the corresponding TICs
%
% .. Author:
%       - Pavan Kumar S, BioSystems Engineering and control (BiSECt) lab, IIT Madras
%       - Based on: Schroeder, W. L., & Saha, R. (2020). OptFill: a tool 
%                   for infeasible cycle-free gapfilling of stoichiometric 
%                   metabolic models. IScience, 23(1).
m_Db = mergeTwoModels(model,database); % the combined model
m_Db.origin = ismember(m_Db.rxns,model.rxns); % boolean vector indicating if a reaction is from model (1) or the database (0)
% parameters used were taken from the OptFill paper
epsilon=0.001;
M=1000;
tolerance=1e-6; 
changeCobraSolverParams('LP', 'feasTol', tolerance);
[~,max_phi] = size(m_Db.S); % number of reactions in the model-database pair
IrR = m_Db.ub<=0; % reactions irreversible in reverse direction
temp = m_Db.ub(IrR);
m_Db.S(:,IrR) = -m_Db.S(:,IrR);
m_Db.ub(IrR) = -1*m_Db.lb(IrR);
m_Db.lb(IrR) = -1*temp;
rev = ones(n,1);
rev(m_Db.lb>=0) = 0;
m_Db.rev=rev;
% converting all the positive lower bounds to zero lower bounds
m_Db.lb(m_Db.lb>0)=0;
% normalising the bounds to max of M
temp1 = max(abs(m_Db.lb));
temp2 = max(abs(m_Db.ub));
m_Db.lb(abs(m_Db.lb)==temp1) = sign(m_Db.lb(abs(m_Db.lb)==temp1))*M;
m_Db.ub(abs(m_Db.ub)==temp2) = sign(m_Db.ub(abs(m_Db.ub)==temp2))*M;
ind = findExcRxns(m_Db); % indices of the exchange reactions
% blocking all the exchange reactions
m_Db.lb(ind) = 0;
m_Db.ub(ind) = 0;
TICs={}; Direction = {}; % empty cell to store the TICs and their respective direction
for phi = 2:max_phi % minimum size of a TIC has to be two
    found_all = false;
    while ~found_all
        [flux,stat] = findTIC(m_Db,phi,mTFP);
        
        
        
    end
end
end
%%
function [flux,stat] = findTIC(model,phi,mTFP)
    
end
##### SOURCE END #####
-->
</div></body></html>